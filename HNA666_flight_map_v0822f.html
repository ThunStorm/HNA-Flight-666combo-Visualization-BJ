
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HNA666随心飞航线可视化系统</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        :root {
            --primary-color: #8E6289;
            --primary-hover: #E77B73;
            --background-primary: #ffffff;
            --background-secondary: rgba(250, 240, 242, 0.2);
            --text-primary: #0F0508;
            --text-secondary: #8e8e93;
            --border-color: rgba(141, 125, 129, 0.12);
            --border-color-dark: rgba(141, 125, 129, 0.24);
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.1);
            --backdrop-filter: blur(20px);
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --background-primary: #000000;
                --background-secondary: rgba(15, 5, 8, 0.2);;
                --text-primary: #ffffff;
                --text-secondary: #8e8e93;
                --border-color: rgba(141, 125, 129, 0.24);
                --border-color-dark: rgba(141, 125, 129, 0.36);
                --shadow-light: rgba(0, 0, 0, 0.3);
                --shadow-medium: rgba(0, 0, 0, 0.4);
            }
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background-primary);
            overflow: hidden;
        }
        
        #map {
            height: 100vh;
            width: 100vw;
        }
        
        /* 地图暗黑模式适配 */
        @media (prefers-color-scheme: dark) {
            .leaflet-layer,
            .leaflet-control-zoom-in,
            .leaflet-control-zoom-out,
            .leaflet-control-layers,
            .leaflet-control {
                filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
            }
        }
        
        /* 确保UI控件不受地图滤镜影响 */
        @media (prefers-color-scheme: dark) {
            .leaflet-control-zoom,
            .leaflet-control-layers,
            .leaflet-control-attribution {
                filter: brightness(1.43) invert(1) contrast(0.33) hue-rotate(-200deg) saturate(3.33) brightness(1.43);
            }
        }
        
        /* 圆形筛选按钮 - 独立显示 */
        .filter-toggle-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1001;
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: var(--background-secondary);
            backdrop-filter: var(--backdrop-filter);
            -webkit-backdrop-filter: var(--backdrop-filter);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px var(--shadow-medium);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
            user-select: none;
        }
                
        .filter-toggle-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 40px var(--shadow-medium);
        }
        
        .filter-toggle-btn:active {
            transform: scale(0.95);
        }
        
        /* 悬浮控制面板样式 - 左上角布局 */
        .control-panel {
            position: absolute;
            top: 20px;
            left: 80px;
            z-index: 1000;
            background: var(--background-secondary);
            backdrop-filter: var(--backdrop-filter);
            -webkit-backdrop-filter: var(--backdrop-filter);
            padding: 16px 20px;
            border-radius: 25px;
            box-shadow: 0 8px 40px var(--shadow-medium);
            color: var(--text-primary);
            max-width: min(95vw, 500px);
            width: 480px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            max-height: 80vh;
            overflow-y: auto;
            opacity: 0;
            transform: translateX(-20px);
            pointer-events: none;
        }
        
        .control-panel.visible {
            opacity: 1;
            transform: translateX(0);
            pointer-events: all;
        }
        
        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .control-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .close-panel-btn {
            width: 32px;
            height: 32px;
            border-radius: 25px;
            background: var(--border-color);
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .close-panel-btn:hover {
            background: var(--border-color-dark);
            color: var(--text-primary);
            transform: scale(1.05);
        }
        
        .close-panel-btn:active {
            transform: scale(0.95);
        }
        
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            align-items: end;
        }
        
        .filter-row.single {
            grid-template-columns: 1fr;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .control-group label {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
        }
        
        select, input[type="text"] {
            padding: 8px 12px;
            border: none;
            border-radius: 19px;
            background: var(--border-color);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
            min-height: 36px;
            width: 100%;
        }
        
        select:focus, input[type="text"]:focus {
            outline: none;
            background: rgba(0, 122, 255, 0.1);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.3);
        }
        
        /* 下拉列表箭头 */
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238e8e93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 36px;
        }
        
        @media (prefers-color-scheme: dark) {
            select {
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            }
        }
        
        select option {
            background: var(--background-primary);
            color: var(--text-primary);
            padding: 8px 12px;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-top: 3px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px 8px;
            border-radius: 19px;
            background: var(--border-color);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            min-height: 32px;
        }
        
        .checkbox-item.checked {
            background: var(--primary-color);
            color: white;
        }
        
        .checkbox-item input {
            display: none;
        }
        
        .buttons-row {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        /* 图例样式 */
        .legend {
            position: absolute;
            bottom: 120px;
            right: 20px;
            background: var(--background-secondary);
            backdrop-filter: var(--backdrop-filter);
            -webkit-backdrop-filter: var(--backdrop-filter);
            padding: 14px;
            border-radius: 19px;
            box-shadow: 0 8px 32px var(--shadow-medium);
            z-index: 1000;
            font-size: 12px;
            min-width: 130px;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .legend h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 3px;
            margin-right: 8px;
            border-radius: 11px;
        }
        
        /* 免责声明 - 悬浮居中 */
        .disclaimer {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: var(--background-secondary);
            backdrop-filter: var(--backdrop-filter);
            -webkit-backdrop-filter: var(--backdrop-filter);
            padding: 12px 20px;
            border-radius: 19px;
            box-shadow: 0 8px 32px var(--shadow-medium);
            color: var(--text-secondary);
            font-size: 11px;
            max-width: min(90vw, 800px);
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .disclaimer p {
            margin: 4px 0;
            line-height: 1.4;
        }
        
        /* 信息面板 */
        #info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: var(--background-secondary);
            backdrop-filter: var(--backdrop-filter);
            -webkit-backdrop-filter: var(--backdrop-filter);
            padding: 18px;
            border-radius: 19px;
            box-shadow: 0 8px 32px var(--shadow-medium);
            z-index: 1000;
            max-width: 380px;
            font-size: 13px;
            max-height: 55vh;
            overflow-y: auto;
            display: none;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .flight-item {
            border-bottom: 1px solid var(--border-color);
            padding: 10px 0;
            margin: 5px 0;
        }
        
        .flight-item:last-child {
            border-bottom: none;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 14px;
            width: 26px;
            height: 26px;
            border-radius: 19px;
            background: var(--border-color);
            color: var(--text-secondary);
            font-size: 16px;
            line-height: 26px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: var(--border-color-dark);
            color: var(--text-primary);
        }
        
        button {
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 19px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            min-height: 36px;
            flex: 1;
        }
        
        button:hover {
            background: var(--primary-hover);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        /* 调试面板样式 */
        .debug-panel {
            position: absolute;
            top: 80px;
            left: 580px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 11px;
            font-size: 10px;
            z-index: 1001;
            max-width: 280px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            .filter-toggle-btn {
                top: 10px;
                left: 10px;
                width: 44px;
                height: 44px;
                border-radius: 22px;
                font-size: 12px;
            }
            
            .control-panel {
                top: 10px;
                left: 10px;
                right: 10px;
                width: auto;
                max-width: none;
                padding: 12px 16px;
                border-radius: 19px;
            }
            
            .control-panel.visible {
                transform: translateY(0);
            }
            
            .filter-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .checkbox-group {
                grid-template-columns: repeat(7, 1fr);
                gap: 4px;
            }
            
            .checkbox-item {
                padding: 8px 4px;
                font-size: 12px;
                min-height: 40px;
            }
            
            .legend {
                bottom: 100px;
                right: 10px;
                padding: 12px;
                font-size: 11px;
                min-width: 120px;
            }
            
            .disclaimer {
                bottom: 10px;
                padding: 10px 16px;
                font-size: 10px;
                max-width: 95vw;
            }
            
            #info-panel {
                bottom: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
                max-height: 45vh;
                padding: 16px;
            }
            
            select, input[type="text"], button {
                font-size: 16px; /* 防止iOS缩放 */
                min-height: 44px;
                padding: 12px 16px;
            }
            
            select {
                padding-right: 44px;
            }
            
            .control-group label {
                font-size: 14px;
            }
            
            .debug-panel {
                left: 20px;
                top: 120px;
                max-width: calc(100vw - 40px);
            }
        }
        
        @media (max-width: 480px) {
            .checkbox-group {
                gap: 2px;
            }
            
            .checkbox-item {
                padding: 6px 2px;
                font-size: 11px;
                min-height: 36px;
            }
            
            .control-panel {
                padding: 10px 12px;
            }
        }
        
        /* 航线hover效果 */
        .route-line {
            cursor: pointer;
        }
        
        .route-line:hover {
            stroke-width: 6 !important;
        }
        
        /* 大屏端优化 */
        @media (min-width: 1024px) {
            .filter-toggle-btn {
                width: 56px;
                height: 56px;
                border-radius: 35px;
                font-size: 14px;
            }
            
            .control-panel {
                padding: 18px 24px;
                gap: 14px;
                width: 520px;
                left: 90px;
            }
            
            .filter-row {
                gap: 16px;
            }
            
            .control-group label {
                font-size: 14px;
                margin-bottom: 4px;
            }
            
            select, input[type="text"] {
                padding: 10px 14px;
                font-size: 14px;
                min-height: 40px;
            }
            
            select {
                padding-right: 42px;
                background-size: 18px;
            }
            
            button {
                padding: 10px 20px;
                font-size: 14px;
                min-height: 40px;
            }
            
            .checkbox-item {
                padding: 8px 12px;
                font-size: 13px;
                min-height: 36px;
            }
            
            .legend {
                padding: 16px;
                font-size: 13px;
                min-width: 140px;
                bottom: 140px;
            }
            
            .legend h4 {
                font-size: 15px;
                margin-bottom: 12px;
            }
            
            .disclaimer {
                padding: 14px 24px;
                font-size: 12px;
                max-width: min(85vw, 900px);
            }
            
            .disclaimer p {
                margin: 5px 0;
            }
            
            #info-panel {
                padding: 20px;
                font-size: 14px;
                max-width: 400px;
                max-height: 60vh;
            }
            
            .flight-item {
                padding: 12px 0;
                margin: 8px 0;
            }
            
            .close-btn {
                width: 28px;
                height: 28px;
                border-radius: 19px;
                font-size: 18px;
                line-height: 28px;
                top: 12px;
                right: 16px;
            }
            
            .close-panel-btn {
                width: 36px;
                height: 36px;
                border-radius: 19px;
                font-size: 18px;
            }
            
            .debug-panel {
                left: 630px;
                top: 100px;
            }
        }
        
        /* 确保Leaflet控件不与筛选面板冲突 */
        .leaflet-top.leaflet-left {
            top: 100px;
            left: 620px;
        }
        
        @media (max-width: 768px) {
            .leaflet-top.leaflet-left {
                top: 20px;
                left: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- 独立的圆形筛选按钮 -->
    <div class="filter-toggle-btn" id="filter-toggle-btn" onclick="toggleControlPanel()">
        筛选
    </div>
    
    <!-- 悬浮控制面板 - 左上角 -->
    <div class="control-panel" id="control-panel">
        
        <div class="filter-section">
            <!-- 星期筛选 -->
            <div class="filter-row single">
                <div class="control-group">
                    <label>周几</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item checked" onclick="toggleDay(1)">
                            <input type="checkbox" id="day1" checked>
                            一
                        </div>
                        <div class="checkbox-item checked" onclick="toggleDay(2)">
                            <input type="checkbox" id="day2" checked>
                            二
                        </div>
                        <div class="checkbox-item checked" onclick="toggleDay(3)">
                            <input type="checkbox" id="day3" checked>
                            三
                        </div>
                        <div class="checkbox-item checked" onclick="toggleDay(4)">
                            <input type="checkbox" id="day4" checked>
                            四
                        </div>
                        <div class="checkbox-item checked" onclick="toggleDay(5)">
                            <input type="checkbox" id="day5" checked>
                            五
                        </div>
                        <div class="checkbox-item checked" onclick="toggleDay(6)">
                            <input type="checkbox" id="day6" checked>
                            六
                        </div>
                        <div class="checkbox-item checked" onclick="toggleDay(7)">
                            <input type="checkbox" id="day7" checked>
                            日
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 第一行：航司筛选、航班时段筛选 -->
            <div class="filter-row">
                <div class="control-group">
                    <label>航司筛选</label>
                    <select id="airline-filter">
                        <option value="">所有航司</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>航班时段筛选</label>
                    <select id="time-period-filter">
                        <option value="">所有时段</option>
                        <option value="morning">仅早班</option>
                        <option value="evening">仅晚班</option>
                    </select>
                </div>
            </div>
            
            <!-- 第二行：机场筛选、机场方向筛选 -->
            <div class="filter-row">
                <div class="control-group">
                    <label>机场筛选</label>
                    <select id="airport-filter">
                        <option value="">所有机场</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>机场方向筛选</label>
                    <select id="airport-direction">
                        <option value="">到达+出发</option>
                        <option value="departure">仅出发</option>
                        <option value="arrival">仅到达</option>
                    </select>
                </div>
            </div>
            
            <!-- 第四行：去程航班时段、回程航班时段筛选 -->
            <div class="filter-row">
                <div class="control-group">
                    <label>去程航班时段</label>
                    <select id="departure-time-filter">
                        <option value="">不限</option>
                        <option value="morning">早班</option>
                        <option value="evening">晚班</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>回程航班时段</label>
                    <select id="arrival-time-filter">
                        <option value="">不限</option>
                        <option value="morning">早班</option>
                        <option value="evening">晚班</option>
                    </select>
                </div>
            </div>
            
            <!-- 第五行：去程航班日期筛选 -->
            <div class="filter-row single">
                <div class="control-group">
                    <label>去程航班日期</label>
                    <div class="checkbox-group" id="departure-days-group">
                        <div class="checkbox-item checked" onclick="toggleDepartureDay(1)">
                            <input type="checkbox" id="departure-day1" checked>
                            一
                        </div>
                        <div class="checkbox-item checked" onclick="toggleDepartureDay(2)">
                            <input type="checkbox" id="departure-day2" checked>
                            二
                        </div>
                        <div class="checkbox-item checked" onclick="toggleDepartureDay(3)">
                            <input type="checkbox" id="departure-day3" checked>
                            三
                        </div>
                        <div class="checkbox-item checked" onclick="toggleDepartureDay(4)">
                            <input type="checkbox" id="departure-day4" checked>
                            四
                        </div>
                        <div class="checkbox-item checked" onclick="toggleDepartureDay(5)">
                            <input type="checkbox" id="departure-day5" checked>
                            五
                        </div>
                        <div class="checkbox-item checked" onclick="toggleDepartureDay(6)">
                            <input type="checkbox" id="departure-day6" checked>
                            六
                        </div>
                        <div class="checkbox-item checked" onclick="toggleDepartureDay(7)">
                            <input type="checkbox" id="departure-day7" checked>
                            日
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 第六行：回程航班日期筛选 -->
            <div class="filter-row single">
                <div class="control-group">
                    <label>回程航班日期</label>
                    <div class="checkbox-group" id="arrival-days-group">
                        <div class="checkbox-item checked" onclick="toggleArrivalDay(1)">
                            <input type="checkbox" id="arrival-day1" checked>
                            一
                        </div>
                        <div class="checkbox-item checked" onclick="toggleArrivalDay(2)">
                            <input type="checkbox" id="arrival-day2" checked>
                            二
                        </div>
                        <div class="checkbox-item checked" onclick="toggleArrivalDay(3)">
                            <input type="checkbox" id="arrival-day3" checked>
                            三
                        </div>
                        <div class="checkbox-item checked" onclick="toggleArrivalDay(4)">
                            <input type="checkbox" id="arrival-day4" checked>
                            四
                        </div>
                        <div class="checkbox-item checked" onclick="toggleArrivalDay(5)">
                            <input type="checkbox" id="arrival-day5" checked>
                            五
                        </div>
                        <div class="checkbox-item checked" onclick="toggleArrivalDay(6)">
                            <input type="checkbox" id="arrival-day6" checked>
                            六
                        </div>
                        <div class="checkbox-item checked" onclick="toggleArrivalDay(7)">
                            <input type="checkbox" id="arrival-day7" checked>
                            日
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 第七行：是否往返筛选 -->
            <div class="filter-row single">
                <div class="control-group">
                    <label>是否往返</label>
                    <select id="round-trip-filter">
                        <option value="">不限</option>
                        <option value="yes">是</option>
                        <option value="no">否</option>
                    </select>
                </div>
            </div>
            
            <!-- 第三行：机型筛选、机型大小筛选 -->
            <div class="filter-row">
                <div class="control-group">
                    <label>机型筛选</label>
                    <select id="aircraft-type-filter">
                        <option value="">所有机型</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>宽窄筛选</label>
                    <select id="aircraft-size-filter">
                        <option value="">所有尺寸</option>
                    </select>
                </div>
            </div>
            
            <!-- 按钮行 -->
            <div class="buttons-row">
                <button onclick="resetFilters()">重置筛选</button>
            </div>
        </div>
    </div>
    
    <!-- 调试信息显示 -->
    <div id="debug-panel" class="debug-panel" style="display: none;">
        <div id="debug-content"></div>
    </div>
    
    <!-- 图例 -->
    <div class="legend">
        <h4>图例</h4>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #FF8C61;"></div>
            早班航线
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #4E598C;"></div>
            晚班航线
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #CE6A85;"></div>
            早晚航线
        </div>
        <div class="legend-item">
            <div style="margin-right: 10px;">✈✈</div>
            航线方向
        </div>
    </div>
    
    <!-- 信息面板 -->
    <div id="info-panel">
        <div class="close-btn" onclick="hideInfoPanel()" title="关闭">&times;</div>
        <div id="info-content"></div>
    </div>
    
    <!-- 免责声明 -->
    <div class="disclaimer">
    <p><strong>免责声明：</strong>本html为本地文件，航线不会更新；机场坐标来自公开数据，可能有误。</p>
    <p>航班数据截至 2025.08.22，仅供参考。感谢 @安排生活 提供，建议配合 
        <a href="https://docs.qq.com/sheet/DY2Zsd2FEZVNKZE1T?tab=BB08J2" target="_blank" style="color:#8E6289;">文档</a> 食用。
    </p>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    
    <script src="flightsDB.js"></script>

    <script>      
        // 初始化地图
        const map = L.map('map').setView([33.31797736193549, 109.36922896580644], 5);
        
        // 定义多个地图底图选项
        const baseMaps = {
            // 高德大字
            "高德大字": L.tileLayer('https://webst0{s}.is.autonavi.com/appmaptile?style=7&x={x}&y={y}&z={z}',{
                subdomains: ['1','2','3','4'],
                attribution: '© 高德地图'
            }),

            // 高德标准
            "高德标准": L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                subdomains: ['1', '2', '3', '4'],
                attribution: '© 高德地图'
            }),
        
            // 高德卫星图
            "高德卫星": L.tileLayer('https://webst0{s}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}', {
                subdomains: ['1', '2', '3', '4'],
                attribution: '© 高德地图'
            }),
           
            // OpenStreetMap
            "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }),
        };
        
        // 默认使用高德地图
        baseMaps["高德大字"].addTo(map);
        
        // 添加图层控制器 - 移到右侧
        const layerControl = L.control.layers(baseMaps);
        layerControl.setPosition('topright');
        layerControl.addTo(map);
        
        // 确保缩放控件也在右侧
        map.zoomControl.setPosition('topright');
        
        // 存储图层
        let routeLayers = [];
        let airportMarkers = [];
        let selectedAirport = null;
        let panelVisible = false;
        
        // 控制面板切换
        function toggleControlPanel() {
            const panel = document.getElementById('control-panel');
            panelVisible = !panelVisible;
            
            if (panelVisible) {
                panel.classList.add('visible');
            } else {
                panel.classList.remove('visible');
            }
        }
        
        // 星期切换
        function toggleDay(day) {
            const checkbox = document.getElementById(`day${day}`);
            const item = checkbox.parentElement;
            
            checkbox.checked = !checkbox.checked;
            item.classList.toggle('checked', checkbox.checked);
            
            updateDisplay();
        }
        
        // 调试函数
        function updateDebugInfo(message) {
            const debugPanel = document.getElementById('debug-panel');
            const debugContent = document.getElementById('debug-content');
            debugContent.innerHTML = message;
            debugPanel.style.display = 'block';
            
            // 3秒后自动隐藏
            setTimeout(() => {
                debugPanel.style.display = 'none';
            }, 0);
        }
        
        // 隐藏信息面板
        function hideInfoPanel() {
            document.getElementById('info-panel').style.display = 'none';
        }
        
        // 显示信息面板
        function showInfoPanel(route, matchingFlights) {
            let flightInfo = '';
            matchingFlights.forEach(flight => {
                const depTime = flight.departure_time ? flight.departure_time.display : '未知';
                const arrTime = flight.arrival_time ? flight.arrival_time.display : '未知';
                const days = flight.days.map(d => ['日','一','二','三','四','五','六'][d]).join('');
                
                flightInfo += `
                    <div class="flight-item">
                        <strong>${flight.airline} ${flight.flight_number}</strong><br>
                        <small>时间: ${depTime} - ${arrTime}</small><br>
                        <small>执飞: 周${days} | ${flight.is_morning ? '早班' : '晚班'}</small><br>
                        <small>机型: ${flight.aircraft_type} (${flight.aircraft_size})</small>
                    </div>
                `;
            });
            
            const info = `
                <h4>${route.departure} → ${route.arrival}</h4>
                <p><strong>航线类型：</strong>${route.route_type} | <strong>航班数：</strong>${matchingFlights.length}</p>
                <p><strong>航空公司：</strong>${route.airlines.join(', ')}</p>
                <p><strong>机型：</strong>${route.aircraft_types.join(', ')}(仅供参考)</p>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${flightInfo}
                </div>
            `;
            
            document.getElementById('info-content').innerHTML = info;
            document.getElementById('info-panel').style.display = 'block';
        }
        
        // 计算弧形路径点
        function calculateArcPoints(start, end, curvature = 0.3) {
            const startLat = start[0] * Math.PI / 180;
            const startLng = start[1] * Math.PI / 180;
            const endLat = end[0] * Math.PI / 180;
            const endLng = end[1] * Math.PI / 180;
            
            // 计算中点
            const dLng = endLng - startLng;
            const bX = Math.cos(endLat) * Math.cos(dLng);
            const bY = Math.cos(endLat) * Math.sin(dLng);
            const midLat = Math.atan2(Math.sin(startLat) + Math.sin(endLat),
                Math.sqrt((Math.cos(startLat) + bX) * (Math.cos(startLat) + bX) + bY * bY));
            const midLng = startLng + Math.atan2(bY, Math.cos(startLat) + bX);
            
            // 计算偏移
            const distance = Math.sqrt(Math.pow(end[0] - start[0], 2) + Math.pow(end[1] - start[1], 2));
            const offset = distance * curvature;
            
            // 垂直方向偏移
            const perpLat = -(end[1] - start[1]) / distance * offset;
            const perpLng = (end[0] - start[0]) / distance * offset;
            
            const controlLat = (midLat * 180 / Math.PI) + perpLat;
            const controlLng = (midLng * 180 / Math.PI) + perpLng;
            
            // 生成弧形路径点
            const points = [];
            const numPoints = 20;
            
            for (let i = 0; i <= numPoints; i++) {
                const t = i / numPoints;
                const t1 = 1 - t;
                
                // 二次贝塞尔曲线
                const lat = t1 * t1 * start[0] + 2 * t1 * t * controlLat + t * t * end[0];
                const lng = t1 * t1 * start[1] + 2 * t1 * t * controlLng + t * t * end[1];
                
                points.push([lat, lng]);
            }
            
            return points;
        }
        
        // 初始化控件
        function initializeControls() {
            // 填充航司选项
            const airlines = ["\u4e4c\u9c81\u6728\u9f50\u822a\u7a7a", "\u5317\u90e8\u6e7e\u822a\u7a7a", "\u5927\u65b0\u534e\u822a\u7a7a", "\u5929\u6d25\u822a\u7a7a", "\u6d77\u5357\u822a\u7a7a", "\u7965\u9e4f\u822a\u7a7a", "\u798f\u5dde\u822a\u7a7a", "\u897f\u90e8\u822a\u7a7a", "\u91d1\u9e4f\u822a\u7a7a", "\u957f\u5b89\u822a\u7a7a", "\u9996\u90fd\u822a\u7a7a"];
            const airlineSelect = document.getElementById('airline-filter');
            airlines.forEach(airline => {
                const option = document.createElement('option');
                option.value = airline;
                option.textContent = airline;
                airlineSelect.appendChild(option);
            });
            
            // 填充机场选项
            const airportSelect = document.getElementById('airport-filter');
            airports.sort((a, b) => a[0].localeCompare(b[0]));
            airports.forEach(([name, lat, lng]) => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                airportSelect.appendChild(option);
            });
            
            // 填充机型选项
            const aircraftTypes = ["A319", "A320", "A321", "A32M", "A32N", "A32V", "A330", "A332", "A333", "B737", "B738", "B788", "B789", "B7LX", "B7M8", "E190"];
            const aircraftTypeSelect = document.getElementById('aircraft-type-filter');
            aircraftTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                aircraftTypeSelect.appendChild(option);
            });
            
            // 填充机型大小选项
            const aircraftSizes = ["\u4e2d\u578b", "\u5927\u578b", "\u5c0f\u578b"];
            const aircraftSizeSelect = document.getElementById('aircraft-size-filter');
            aircraftSizes.forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                aircraftSizeSelect.appendChild(option);
            });
            
            // 绑定事件
            document.querySelectorAll('select').forEach(element => {
                element.addEventListener('change', updateDisplay);
            });

            // 设置默认随机选择的机场
            if (airports.length > 0) {
                const defaultAirport = airports[Math.floor(Math.random() * airports.length)][0];
                document.getElementById('airport-filter').value = defaultAirport;
                selectedAirport = defaultAirport;
            }

            const defaultAirport = airports[Math.floor(Math.random() * airports.length)][0]; // 随机选择机场
        }
        
        // 创建机场标记
        function createAirportMarkers() {
            airportMarkers.forEach(marker => map.removeLayer(marker));
            airportMarkers = [];
            
            airports.forEach(([name, lat, lng]) => {
                const marker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: selectedAirport === name ? '#E77B73' : '#8E6289',
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                
                marker.bindTooltip(name, {permanent: false, direction: 'top'});
                
                marker.on('click', function(e) {
                    // 阻止事件冒泡
                    e.originalEvent.stopPropagation();
                    selectedAirport = selectedAirport === name ? null : name;
                    document.getElementById('airport-filter').value = selectedAirport || '';
                    updateDisplay();
                });
                
                airportMarkers.push(marker);
            });
        }
        
        // 获取当前筛选条件
        function getCurrentFilters() {
            const selectedDays = [];
            for (let i = 1; i <= 7; i++) {
                if (document.getElementById(`day${i}`).checked) {
                    selectedDays.push(i);
                }
            }
            
            const departureDays = [];
            for (let i = 1; i <= 7; i++) {
                if (document.getElementById(`departure-day${i}`).checked) {
                    departureDays.push(i);
                }
            }
            
            const arrivalDays = [];
            for (let i = 1; i <= 7; i++) {
                if (document.getElementById(`arrival-day${i}`).checked) {
                    arrivalDays.push(i);
                }
            }
            
            return {
                days: selectedDays,
                airline: document.getElementById('airline-filter').value,
                timePeriod: document.getElementById('time-period-filter').value,
                airport: document.getElementById('airport-filter').value,
                airportDirection: document.getElementById('airport-direction').value,
                departureTime: document.getElementById('departure-time-filter').value,
                arrivalTime: document.getElementById('arrival-time-filter').value,
                departureDays: departureDays,
                arrivalDays: arrivalDays,
                roundTrip: document.getElementById('round-trip-filter').value,
                aircraftType: document.getElementById('aircraft-type-filter').value,
                aircraftSize: document.getElementById('aircraft-size-filter').value
            };
        }
        
        // 航线筛选逻辑
        function routeMatchesFilters(route, filters) {
            // 1. 首先进行航线级别的时段筛选
            if (filters.timePeriod) {
                if (filters.timePeriod === 'morning' && !route.has_morning) {
                    return false;
                }
                if (filters.timePeriod === 'evening' && !route.has_evening) {
                    return false;
                }
            }
            
            // 2. 机场方向筛选（航线级别）
            if (filters.airport) {
                if (filters.airportDirection === 'departure' && route.departure !== filters.airport) {
                    return false;
                }
                if (filters.airportDirection === 'arrival' && route.arrival !== filters.airport) {
                    return false;
                }
                if (!filters.airportDirection && route.departure !== filters.airport && route.arrival !== filters.airport) {
                    return false;
                }
            }
            
            // 3. 检查是否有符合其他条件的航班
            const matchingFlights = route.flights.filter(flight => {
                // 检查日期
                if (!flight.days.some(day => filters.days.includes(day))) {
                    return false;
                }
                
                // 检查航司
                if (filters.airline && flight.airline !== filters.airline) {
                    return false;
                }
                
                // 检查机型
                if (filters.aircraftType && flight.aircraft_type !== filters.aircraftType) {
                    return false;
                }
                
                // 检查机型大小
                if (filters.aircraftSize && flight.aircraft_size !== filters.aircraftSize) {
                    return false;
                }
                
                // 航班级别的时段筛选（与航线级筛选一致）
                if (filters.timePeriod === 'morning' && !flight.is_morning) {
                    return false;
                }
                if (filters.timePeriod === 'evening' && flight.is_morning) {
                    return false;
                }
                
                // 去程航班时段筛选：departure字段值为所选机场的航班
                if (filters.departureTime && filters.airport) {
                    const isDepartureFlight = flight.departure === filters.airport;
                    if (isDepartureFlight) {
                        if (filters.departureTime === 'morning' && !flight.is_morning) {
                            return false;
                        }
                        if (filters.departureTime === 'evening' && flight.is_morning) {
                            return false;
                        }
                    }
                }
                
                // 回程航班时段筛选：arrival字段值为所选机场的航班
                if (filters.arrivalTime && filters.airport) {
                    const isArrivalFlight = flight.arrival === filters.airport;
                    if (isArrivalFlight) {
                        if (filters.arrivalTime === 'morning' && !flight.is_morning) {
                            return false;
                        }
                        if (filters.arrivalTime === 'evening' && flight.is_morning) {
                            return false;
                        }
                    }
                }
                
                // 去程航班日期筛选：departure字段值为所选机场的航班
                if (filters.departureDays.length < 7 && filters.airport) {
                    const isDepartureFlight = flight.departure === filters.airport;
                    if (isDepartureFlight) {
                        if (!flight.days.some(day => filters.departureDays.includes(day))) {
                            return false;
                        }
                    }
                }
                
                // 回程航班日期筛选：arrival字段值为所选机场的航班
                if (filters.arrivalDays.length < 7 && filters.airport) {
                    const isArrivalFlight = flight.arrival === filters.airport;
                    if (isArrivalFlight) {
                        if (!flight.days.some(day => filters.arrivalDays.includes(day))) {
                            return false;
                        }
                    }
                }
                
                return true;
            });
            
            if (matchingFlights.length === 0) return false;
            
            // 往返筛选
            if (filters.roundTrip === 'yes') {
                // 严格筛选：只显示完整的往返航线（同时有去程和回程）
                
                // 首先检查当前航线是否有对应的回程航线
                const returnRouteKey = `${route.arrival}-${route.departure}`;
                const returnRoute = routes.find(r => r.route_key === returnRouteKey);
                
                // 如果没有对应的回程航线，直接返回false
                if (!returnRoute) {
                    return false;
                }
                
                // 检查当前航线（去程）是否有满足条件的航班
                const hasValidDeparture = route.flights.some(flight => {
                    // 应用完整的航班筛选逻辑
                    if (!flight.days.some(day => filters.days.includes(day))) return false;
                    if (filters.airline && flight.airline !== filters.airline) return false;
                    if (filters.aircraftType && flight.aircraft_type !== filters.aircraftType) return false;
                    if (filters.aircraftSize && flight.aircraft_size !== filters.aircraftSize) return false;
                    if (filters.timePeriod === 'morning' && !flight.is_morning) return false;
                    if (filters.timePeriod === 'evening' && flight.is_morning) return false;
                    
                    // 去程航班时段筛选
                    if (filters.departureTime) {
                        if (filters.departureTime === 'morning' && !flight.is_morning) return false;
                        if (filters.departureTime === 'evening' && flight.is_morning) return false;
                    }
                    
                    // 去程航班日期筛选
                    if (filters.departureDays.length < 7) {
                        if (!flight.days.some(day => filters.departureDays.includes(day))) return false;
                    }
                    
                    return true;
                });
                
                // 检查回程航线是否有满足条件的航班
                const hasValidReturn = returnRoute.flights.some(flight => {
                    // 应用完整的航班筛选逻辑
                    if (!flight.days.some(day => filters.days.includes(day))) return false;
                    if (filters.airline && flight.airline !== filters.airline) return false;
                    if (filters.aircraftType && flight.aircraft_type !== filters.aircraftType) return false;
                    if (filters.aircraftSize && flight.aircraft_size !== filters.aircraftSize) return false;
                    if (filters.timePeriod === 'morning' && !flight.is_morning) return false;
                    if (filters.timePeriod === 'evening' && flight.is_morning) return false;
                    
                    // 回程航班时段筛选
                    if (filters.arrivalTime) {
                        if (filters.arrivalTime === 'morning' && !flight.is_morning) return false;
                        if (filters.arrivalTime === 'evening' && flight.is_morning) return false;
                    }
                    
                    // 回程航班日期筛选
                    if (filters.arrivalDays.length < 7) {
                        if (!flight.days.some(day => filters.arrivalDays.includes(day))) return false;
                    }
                    
                    return true;
                });
                
                // 只有当去程和回程都有满足条件的航班时才显示
                if (!hasValidDeparture || !hasValidReturn) {
                    return false;
                }
            } else if (filters.roundTrip === 'no') {
                // 只需要单程航班，不能有满足所有条件的回程航班
                const hasValidReturn = routes.some(r => {
                    if (r.departure !== route.arrival || r.arrival !== route.departure) return false;
                    return r.flights.some(flight => {
                        // 应用完整的航班筛选逻辑
                        if (!flight.days.some(day => filters.days.includes(day))) return false;
                        if (filters.airline && flight.airline !== filters.airline) return false;
                        if (filters.aircraftType && flight.aircraft_type !== filters.aircraftType) return false;
                        if (filters.aircraftSize && flight.aircraft_size !== filters.aircraftSize) return false;
                        if (filters.timePeriod === 'morning' && !flight.is_morning) return false;
                        if (filters.timePeriod === 'evening' && flight.is_morning) return false;
                        return true;
                    });
                });
                if (hasValidReturn) {
                    return false;
                }
            }
            
            return true;
        }
        
        // 更新显示
        function updateDisplay() {
            // 清除现有航线
            routeLayers.forEach(layer => map.removeLayer(layer));
            routeLayers = [];
            
            // 更新选定机场
            selectedAirport = document.getElementById('airport-filter').value || null;
            createAirportMarkers();
            
            const filters = getCurrentFilters();
            
            // 调试输出
            console.log('当前筛选条件:', filters);
            console.log('总航线数:', routes.length);
            
            // 统计各类型航线数量
            let morningCount = 0, eveningCount = 0, bothCount = 0;
            routes.forEach(route => {
                if (route.has_morning && route.has_evening) bothCount++;
                else if (route.has_morning) morningCount++;
                else if (route.has_evening) eveningCount++;
            });
            
            console.log(`航线统计: 仅早班 ${morningCount}, 仅晚班 ${eveningCount}, 早晚班 ${bothCount}`);
            
            const filteredRoutes = routes.filter(route => routeMatchesFilters(route, filters));
            
            console.log('筛选后航线数:', filteredRoutes.length);
            
            // 更新调试信息
            let debugText = `筛选条件: ${filters.timePeriod || '全部'}时段`;
            if (filters.airport) {
                const directionText = filters.airportDirection === 'departure' ? '出发' : 
                                     filters.airportDirection === 'arrival' ? '到达' : '到达+出发';
                debugText += `<br>机场: ${filters.airport} (${directionText})`;
                if (filters.departureTime) {
                    debugText += `<br>去程: ${filters.departureTime === 'morning' ? '早班' : '晚班'}`;
                }
                if (filters.arrivalTime) {
                    debugText += `<br>回程: ${filters.arrivalTime === 'morning' ? '早班' : '晚班'}`;
                }
                if (filters.departureDays.length < 7) {
                    const daysText = filters.departureDays.map(d => ['一','二','三','四','五','六','日'][d-1]).join('');
                    debugText += `<br>去程日期: ${daysText}`;
                }
                if (filters.arrivalDays.length < 7) {
                    const daysText = filters.arrivalDays.map(d => ['一','二','三','四','五','六','日'][d-1]).join('');
                    debugText += `<br>回程日期: ${daysText}`;
                }
            }
            if (filters.roundTrip) {
                const roundTripText = filters.roundTrip === 'yes' ? '是' : 
                                     filters.roundTrip === 'no' ? '否' : '不限';
                debugText += `<br>往返: ${roundTripText}`;
            }
            debugText += `<br>总航线: ${routes.length}<br>早班: ${morningCount}, 晚班: ${eveningCount}, 早晚班: ${bothCount}<br>筛选后: ${filteredRoutes.length}条`;
            
            updateDebugInfo(debugText);
            
            // 绘制航线
            filteredRoutes.forEach((route, index) => {
                // 计算弧形路径
                const arcPoints = calculateArcPoints(route.departure_coord, route.arrival_coord);
                
                // 创建弧形航线
                const line = L.polyline(arcPoints, {
                    color: route.color,
                    weight: 4,
                    opacity: 0.8,
                    className: 'route-line'
                }).addTo(map);
                
                // 添加圆角箭头
                const decorator = L.polylineDecorator(line, {
                    patterns: [{
                        offset: '15%',
                        repeat: '30%',
                        symbol: L.Symbol.marker({
                            rotate: true,
                            markerOptions: {
                                icon: L.divIcon({
                                    className: "arrow-icon",
                                    html: `<svg width="24" height="16" viewBox="0 0 20 10" style="overflow: visible; transform: rotate(90deg);">
                                        <path d="M0,5 Q3,5 5,3 L15,1 Q19,3 19,5 Q19,7 15,9 L5,7 Q3,5 0,5 Z" 
                                            fill="${route.color}" 
                                            stroke="none"/>
                                    </svg>`,
                                    iconSize: [24, 16],
                                    iconAnchor: [12, 8]
                                })
                            }
                        })
                    }]
                }).addTo(map);
              
                // 为航线添加点击事件
                const clickHandler = function(e) {
                    // 阻止事件冒泡到地图
                    L.DomEvent.stopPropagation(e);
                    
                    console.log('航线被点击:', route.route_key);
                    
                    // 计算符合筛选条件的航班
                    const matchingFlights = route.flights.filter(flight => {
                        // 应用相同的筛选逻辑
                    if (!flight.days.some(day => filters.days.includes(day))) return false;
                    if (filters.airline && flight.airline !== filters.airline) return false;
                    if (filters.aircraftType && flight.aircraft_type !== filters.aircraftType) return false;
                    if (filters.aircraftSize && flight.aircraft_size !== filters.aircraftSize) return false;
                    // 时段筛选
                    if (filters.timePeriod === 'morning' && !flight.is_morning) return false;
                    if (filters.timePeriod === 'evening' && flight.is_morning) return false;
                    
                    // 去程航班时段筛选：departure字段值为所选机场的航班
                    if (filters.departureTime && filters.airport) {
                        const isDepartureFlight = flight.departure === filters.airport;
                        if (isDepartureFlight) {
                            if (filters.departureTime === 'morning' && !flight.is_morning) {
                                return false;
                            }
                            if (filters.departureTime === 'evening' && flight.is_morning) {
                                return false;
                            }
                        }
                    }
                    
                    // 回程航班时段筛选：arrival字段值为所选机场的航班
                    if (filters.arrivalTime && filters.airport) {
                        const isArrivalFlight = flight.arrival === filters.airport;
                        if (isArrivalFlight) {
                            if (filters.arrivalTime === 'morning' && !flight.is_morning) {
                                return false;
                            }
                            if (filters.arrivalTime === 'evening' && flight.is_morning) {
                                return false;
                            }
                        }
                    }
                    
                    // 去程航班日期筛选：departure字段值为所选机场的航班
                    if (filters.departureDays.length < 7 && filters.airport) {
                        const isDepartureFlight = flight.departure === filters.airport;
                        if (isDepartureFlight) {
                            if (!flight.days.some(day => filters.departureDays.includes(day))) {
                                return false;
                            }
                        }
                    }
                    
                    // 回程航班日期筛选：arrival字段值为所选机场的航班
                    if (filters.arrivalDays.length < 7 && filters.airport) {
                        const isArrivalFlight = flight.arrival === filters.airport;
                        if (isArrivalFlight) {
                            if (!flight.days.some(day => filters.arrivalDays.includes(day))) {
                                return false;
                            }
                        }
                    }
                    
                    return true;
                    });
                    
                    // 显示信息面板
                    showInfoPanel(route, matchingFlights);
                };
                
                // 绑定点击事件
                line.on('click', clickHandler);
                decorator.on('click', clickHandler);
                
                routeLayers.push(line);
                routeLayers.push(decorator);
            });
            
            // 更新统计信息
            console.log(`显示 ${filteredRoutes.length} 条航线`);
        }
        
        // 切换去程日期
        function toggleDepartureDay(day) {
            const checkbox = document.getElementById(`departure-day${day}`);
            const item = checkbox.parentElement;
            
            if (checkbox.checked) {
                checkbox.checked = false;
                item.classList.remove('checked');
            } else {
                checkbox.checked = true;
                item.classList.add('checked');
            }
            
            updateDisplay();
        }

        // 切换回程日期
        function toggleArrivalDay(day) {
            const checkbox = document.getElementById(`arrival-day${day}`);
            const item = checkbox.parentElement;
            
            if (checkbox.checked) {
                checkbox.checked = false;
                item.classList.remove('checked');
            } else {
                checkbox.checked = true;
                item.classList.add('checked');
            }
            
            updateDisplay();
        }

        // 重置筛选
        function resetFilters() {
            // 重置所有复选框
            document.querySelectorAll('.checkbox-item').forEach(item => {
                item.classList.add('checked');
                item.querySelector('input').checked = true;
            });
            
            // 重置所有下拉框
            document.querySelectorAll('select').forEach(select => select.value = '');
            
            selectedAirport = null;
            hideInfoPanel();
            updateDisplay();
        }
        
        // 点击地图其他地方隐藏信息面板
        map.on('click', function(e) {
            hideInfoPanel();
        });
        
        // 阻止信息面板内的点击事件冒泡
        document.getElementById('info-panel').addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // 移动端适配：防止双击缩放
        map.doubleClickZoom.disable();
        
        // 初始化
        console.log('正在初始化可视化...');
        console.log('航班数据样例:', flights.slice(0, 2));
        console.log('航线数据样例:', routes.slice(0, 2));
        initializeControls();
        updateDisplay();
        console.log('初始化完成');
    </script>
</body>
</html>
    